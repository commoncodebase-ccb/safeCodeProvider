<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="/static/student/exam_page.css">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Exam Page</title>
  <style>

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Unbounded, serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

.navbar {
    width: 100%;
    background-color: #181d24;
    color: white;
    text-align: center;
    padding: 15px 0;
}

.container {
    display: flex;
    width: 100%;
    flex: 1;
}

.instruction {
    width: 33%;
    background-color: #f8f8f8;
    padding: 20px;
    overflow-y: auto;
}

.instruction-content {
    padding: 10px;
    height: calc(100% - 40px);
}

.right-panel {
    width: 67%;
    display: flex;
    flex-direction: column;
    padding: 20px;
}

.editor {
    flex: 2;
    position: relative;
    background-color: #1e1e1e;
    color: white;
}

#monaco-editor {
    width: 100%;
    height: 100%;
}

#toggle-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}

#output {
    flex: 1;
    background-color: #1e1e1e;
    color: white;
    padding: 15px;
    margin-top: 10px;
}

.buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

button {
    padding: 10px 15px;
    border: none;
    background-color:#ff4d00;
    color: white;
    cursor: pointer;
    padding: 12px;
    width: 120px;
    font-size: 14px;
}

button:hover {
    background-color: #a83200;
}

footer {
    width: 100%;
    text-align: center;
    background-color: #181d24;
    color: white;
    padding: 10px 0;
}
        /* Arka plan overlay */
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        /* Popup içeriği */
        #rusure {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            text-align: center;
            width: 400px;
        }

        /* Butonlar */
        #rusure button {
            margin: 10px;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }

        #rusyesbutton {
            background-color: green;
            color: white;
        }

        #rusnobutton {
            background-color: red;
            color: white;
        }


  </style>
</head>

<body>
    <div class="navbar">
        <h2>Safe Code Provider | Exam Panel <span style="color: #ff4d00; margin-left: 30px;" id="timer">01:59:59</span></h2>
    </div>

    <div class="container">
        <!-- Sol tarafta PDF slaytlarını gösterecek alan -->
        <div class="instruction">
            <h3>Exam Instructions</h3>
            <div style="margin-top: 10px;" class="instruction-content" id="pdf-container">
                <!-- PDF.js ile her sayfa için canvas eklenecek -->
            </div>
        </div>

        <!-- Sağ tarafta kod editörü ve çıktı alanı -->
        <div class="right-panel">
            <div class="editor" id="editor-container">
                <div id="monaco-editor"></div>
                <button id="toggle-btn">Büyüt</button>
            </div>

            <div id="output">Output will be displayed here...</div>

            <div class="buttons">
                <button id="runButton" onclick="saveCode()">Run</button>
                <button id="submitButton" onclick="RUSure()">Submit</button>
            </div>
        </div>
    </div>

    <footer>
        <p>CommonCodeBase</p>
    </footer>  


    <!-- Arka plan overlay -->
    <div id="overlay" onclick="RUSurno()"></div>

  <div id="rusure" style="display: none;">
    <h2>Are You sure to submit?</h2>
      <button id="rusyesbutton" onclick="submitCode()">YES</button>
      <button id="rusnobutton" onclick="RUSurno()">NO</button>
  </div>

  <!-- Zamanlayıcı -->
  <script>
        async function fetchExamTime() {
            try {
                const response = await fetch("/get_exam_time/");
                const data = await response.json();
                if (data.exam_time) {
                    startTimer(data.exam_time * 60);  // Dakika -> Saniyeye çevir
                }
            } catch (error) {
                console.error("Süre alınamadı:", error);
            }
        }

        function startTimer(duration) {
            let timer = duration, hours, minutes, seconds;
            const timerElement = document.getElementById("timer");
            const runButton = document.getElementById("runButton");
            const submitButton = document.getElementById("submitButton");

            function updateTimer() {
                hours = Math.floor(timer / 3600);
                minutes = Math.floor((timer % 3600) / 60);
                seconds = timer % 60;

                timerElement.textContent = 
                    String(hours).padStart(2, '0') + ":" + 
                    String(minutes).padStart(2, '0') + ":" + 
                    String(seconds).padStart(2, '0');

                if (timer > 0) {
                    timer--;
                    setTimeout(updateTimer, 1000);
                } else {
                    // Süre dolunca butonları devre dışı bırak
                    runButton.disabled = true;
                    submitButton.disabled = true;

                    // Butonları gri yapmak için CSS ekle
                    runButton.style.backgroundColor = "#ccc";
                    submitButton.style.backgroundColor = "#ccc";
                    runButton.style.cursor = "not-allowed";
                    submitButton.style.cursor = "not-allowed";
                }
            }

            updateTimer();
        }

        // Sayfa açıldığında süreyi al ve geri sayımı başlat
        fetchExamTime(); 
  </script>
  
  <!-- PDF.js Kütüphanesi -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <script>
      var pdfUrl = '{{ pdf_url }}';
      if (pdfUrl) {
          var pdfjsLib = window['pdfjs-dist/build/pdf'];
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
          
          pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
              var pdfContainer = document.getElementById('pdf-container');
              // Tüm sayfaları render et
              for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                  pdf.getPage(pageNum).then(function(page) {
                      var scale = 1.5;
                      var viewport = page.getViewport({ scale: scale });
                      var canvas = document.createElement('canvas');
                      canvas.style.width = '100%';
                      canvas.style.marginBottom = '10px';
                      var context = canvas.getContext('2d');
                      canvas.height = viewport.height;
                      canvas.width = viewport.width;
                      var renderContext = {
                          canvasContext: context,
                          viewport: viewport
                      };
                      page.render(renderContext);
                      pdfContainer.appendChild(canvas);
                  });
              }
          }).catch(function(error) {
              console.error('PDF yüklenirken hata oluştu: ' + error);
          });
      } else {
          console.error("PDF URL bulunamadı.");
      }
  </script>
  
  <!-- Monaco Editor CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs/loader.js"></script>
  <script>
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.21.2/min/vs' }});

var editor;
var isFullscreen = false;

require(['vs/editor/editor.main'], function() {
    var langMap = {
        'py': 'python',
        'java': 'java',
        'c': 'c'
    };
    var editorLanguage = langMap['{{ exam_type }}'] || 'plaintext';

    var editorContainer = document.getElementById('editor-container');
    var toggleBtn = document.getElementById('toggle-btn');

    // Sayfa açıldığında editör geniş başlayacak
    editorContainer.style.width = "100%";
    editorContainer.style.height = "500px"; // Büyük başlangıç boyutu

    editor = monaco.editor.create(document.getElementById('monaco-editor'), {
        value: `{{ assignment_content|escapejs }}`,
        language: editorLanguage,
        theme: "vs-dark"
    });

    toggleBtn.addEventListener('click', function() {
        if (!isFullscreen) {
            // Tam ekran modu
            editorContainer.style.position = "fixed";
            editorContainer.style.top = "0";
            editorContainer.style.left = "0";
            editorContainer.style.width = "100vw";
            editorContainer.style.height = "100vh";
            editorContainer.style.zIndex = "9999";
            toggleBtn.textContent = "Küçült";
        } else {
            // Başlangıçtaki geniş moda geri dön
            editorContainer.style.position = "";
            editorContainer.style.top = "";
            editorContainer.style.left = "";
            editorContainer.style.width = "100%";
            editorContainer.style.height = "500px";
            editorContainer.style.zIndex = "";
            toggleBtn.textContent = "Büyüt";
        }
        isFullscreen = !isFullscreen;
        editor.layout();
    });
});

      function saveCode() {
        const code = editor.getValue();
        let student_id = localStorage.getItem("student_id"); 
        let student_name = localStorage.getItem("student_name"); 

        console.log("student_id:", student_id);
        console.log("student_name:", student_name);

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch("/save_code/", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({
                student_id: student_id, 
                student_name: student_name, 
                code: code })
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (data.status === "success") {
                runCode(student_id, student_name);  
            }
        })
        .catch(error => console.error("Kod kaydedilirken hata oluştu:", error));
    }   
    
    function runCode(student_id, student_name) {
        console.log(`Container çalıştırılıyor: ${student_id}-${student_name}-container`);
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
        fetch("/run_code/", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({
                student_id: student_id,
                student_name: student_name
            })
        })
        .then(response => response.json())
        .then(data => {
            
            console.log("Çalıştırma Sonucu:", data);

    let outputText = "";

    try {
        // JSON formatında olduğundan emin ol
        const jsonData = typeof data === "string" ? JSON.parse(data) : data;
        outputText = jsonData.output || "Kod çalıştırılırken hata oluştu.";
    } catch (error) {
        console.error("JSON dönüşüm hatası:", error);
        outputText = "Çıktı alınamadı. Sunucu hatası!";
    }

    // Terminal çıktısını frontend'de göster
    document.getElementById("output").innerText = outputText;
        })
        .catch(error => {
            console.error("Kod çalıştırılırken hata oluştu:", error);
            document.getElementById("output").innerText = "Sunucu hatası!";
        });
    }

    function submitCode() {
        const code = editor.getValue();
        let student_id = localStorage.getItem("student_id"); 
        let student_name = localStorage.getItem("student_name"); 

        console.log("student_id:", student_id);
        console.log("student_name:", student_name);

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch("/save_code/", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({
                student_id: student_id, 
                student_name: student_name, 
                code: code })
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (data.status === "success") {
                deleteDocker(student_id,student_name)
            }
        })
        .catch(error => console.error("Kod kaydedilirken hata oluştu:", error));
    }

    function deleteDocker(student_id,student_name) { 

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch("/delete_docker/", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({
                student_id: student_id, 
                student_name: student_name})
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (data.status === "success") {
                alert("game over.")
            }
        })
        .catch(error => console.error("Kod kaydedilirken hata oluştu:", error));
    }

    function RUSure() {
            document.getElementById("overlay").style.display = "block";
            document.getElementById("rusure").style.display = "block";
        }

    function RUSurno() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("rusure").style.display = "none";
    }

  </script>
</body>
</html>